(function($){var kendo=window.kendo,ui=kendo.ui,grid=ui.Grid;var CHANGE="change";var ExGrid=grid.extend({init:function(element,options){var defaultOptions={sortable:true,groupable:false,selectable:false,editable:false,resizable:true,reorderable:true,noRecords:true,locked:true,messages:{noRecords:"无有效数据"},pageable:{refresh:true,pageSize:20,pageSizes:[20,50,100,200,500]}};var that=this;if(options.extend!==false){options=$.extend(defaultOptions,options)}var definedWidth=0;var undefinedWidthItems=[];$.each(options.columns,function(i,item){if(item.width){definedWidth+=parseInt(item.width)}else{undefinedWidthItems.push(item)}});var gridWidth=$(element).innerWidth();gridWidth=gridWidth-2-17-90-2;var itemWidth=100;if(undefinedWidthItems.length>0){var hasWidth=gridWidth-definedWidth;if(hasWidth>0){itemWidth=Math.max(hasWidth/undefinedWidthItems.length,100)}}$.each(undefinedWidthItems,function(i,item){item.width=itemWidth});if(options.dataBound){var dataBound=options.dataBound;options.dataBound=function(e){e.sender.element.find(':checkbox.check_allRow').prop("checked",false);App.resizeGrid();dataBound()}}else{options.dataBound=function(e){e.sender.element.find(':checkbox.check_allRow').prop("checked",false);App.resizeGrid()}}if(!options.columns[0].attributes){options.columns.splice(0,0,{title:'<input type=\'checkbox\' class=\'check_allRow\'>',width:40,template:'<input type="checkbox" class="check_row">',attributes:{"data-column-type":"check_row","style":"text-align:center"},headerAttributes:{"data-column-type":"check_allRow","style":"text-align:center"},locked:options.locked&&options.detailInit==undefined},{title:"序号",attributes:{"style":"text-align:center"},headerAttributes:{"style":"text-align:center"},template:function(dataItem){return that.dataSource.indexOf(dataItem)+1},width:50,locked:options.locked&&options.detailInit==undefined})}grid.fn.init.call(that,element,options);that.element.on('mouseover','.k-grid-content tr[role="row"]',function(){var index=$(this).index();that.element.find(".k-grid-content-locked tr:eq("+index+")").addClass("mouse-over")});that.element.on('mouseout','.k-grid-content tr[role="row"]',function(){var index=$(this).index();that.element.find(".k-grid-content-locked tr:eq("+index+")").removeClass("mouse-over")});that.element.on('mouseover','.k-grid-content-locked tr[role="row"]',function(){var index=$(this).index();that.element.find(".k-grid-content tr:eq("+index+")").addClass("mouse-over")});that.element.on('mouseout','.k-grid-content-locked tr[role="row"]',function(){var index=$(this).index();that.element.find(".k-grid-content tr:eq("+index+")").removeClass("mouse-over")});that.element.on('click','td[data-column-type="check_row"]',function(e){var cell=$(this);var checkbox=cell.find(":checkbox");if(cell.is(e.target)){checkbox.prop('checked',!checkbox.prop('checked'))}var row=checkbox.closest('tr[role="row"]');var index=row.index();if((checkbox).is(":checked")){row.addClass("k-state-selected");that.element.find("div.k-grid-content table tr:eq("+index+")").addClass("k-state-selected")}else{row.removeClass("k-state-selected");that.element.find("div.k-grid-content table tr:eq("+index+")").removeClass("k-state-selected")}var selectAll=that.element.find('tr[role="row"]').find(':checkbox.check_row:checked').length>=that.element.find('tr[role="row"]').find(':checkbox.check_row').length;that.element.find(':checkbox.check_allRow').prop("checked",selectAll);that.trigger(CHANGE)});that.element.on('click','th[data-column-type="check_allRow"]',function(e){var cell=$(this),checkbox=cell.find(":checkbox");if(cell.is(e.target)){checkbox.prop('checked',!checkbox.prop('checked'))}var row=checkbox.closest('tr[role="row"]');if((checkbox).is(":checked")){that.element.find('tr[role="row"]').addClass("k-state-selected").find(':checkbox.check_row').prop('checked',true)}else{that.element.find('tr[role="row"]').removeClass("k-state-selected").find(':checkbox.check_row').prop('checked',false)}that.trigger(CHANGE)})},options:{name:"ExGrid"},select:function(e){if(e){var rows=this.element.find("div.k-grid-content-locked").find(e).addClass("k-state-selected");rows.find(':checkbox').prop('checked',true);rows=this.element.find(e).addClass("k-state-selected");rows.find(':checkbox').prop('checked',true)}else{return this.element.children('.k-grid-content').find('tr.k-state-selected[role="row"]')}},getSelectedData:function(){var selectedData=[];var that=this;that.select().each(function(i,row){selectedData.push(that.dataItem(row))});return selectedData},getSelectedId:function(){var selectedId=[];var that=this;that.select().each(function(i,row){selectedId.push(that.dataItem(row).id)});return selectedId},clearSelection:function(){this.element.find("div table tr").removeClass("k-state-selected");this.element.find(':checkbox').prop("checked",false)}});ui.plugin(ExGrid);var DropDownTreeView=kendo.ui.Widget.extend({_uid:null,_treeView:null,_dropdown:null,_v:null,_valueObject:null,init:function(element,options){var self=this;kendo.ui.Widget.fn.init.call(self,element,options);self._uid=new Date().getTime();var optionLabel=options.placeholder||"请选择...";$(element).attr("type","hidden");$(element).before(kendo.format("<input id='extDropDown{0}' class='k-ext-dropdown'/>",self._uid));$(element).before(kendo.format("<div id='extTreeView{0}' class='k-ext-treeview' style='z-index:1;'/>",self._uid));self._dropdown=$(kendo.format("#extDropDown{0}",self._uid)).kendoDropDownList({dataSource:[{text:"",value:""}],dataTextField:"text"||options.textField,dataValueField:"value"||options.valueField,optionLabel:optionLabel,value:""||$(element).val(),open:function(e){e.preventDefault();if(!$(element).attr("readonly")){if(!$treeViewRootElem.hasClass("k-custom-visible")){$treeViewRootElem.css({"top":$dropdownRootElem.position().top+$dropdownRootElem.height(),"left":$dropdownRootElem.position().left});$treeViewRootElem.slideToggle('fast',function(){self._dropdown.close();if(self._valueObject)$dropdownRootElem.find("span.k-input").text(self._valueObject[options.textField]);$treeViewRootElem.addClass("k-custom-visible")})}}}}).data("kendoDropDownList");var $dropdownRootElem=$(self._dropdown.element).closest("span.k-dropdown");self._treeView=$(kendo.format("#extTreeView{0}",self._uid)).kendoTreeView(options.treeView).data("kendoTreeView");self._treeView.bind("select",function(e){$dropdownRootElem.find("span.k-input").text($(e.node).children("div").text());$treeViewRootElem.slideToggle('fast',function(){$treeViewRootElem.removeClass("k-custom-visible");self.trigger("select",e);if(options.change){$dropdownRootElem.trigger("change",options.change(e))}});var treeValue=this.dataItem(e.node);self._valueObject=treeValue;self._v=treeValue[options.valueField];$(element).val(self._v);$(element).trigger("change")});var $treeViewRootElem=$(self._treeView.element).closest("div.k-treeview");$treeViewRootElem.css({"border":"1px solid #dbdbdb","display":"none","position":"absolute","background-color":self._dropdown.list.css("background-color")});$(document).click(function(e){if($(e.target).closest("div.k-treeview").length===0){if($treeViewRootElem.hasClass("k-custom-visible")){$treeViewRootElem.slideToggle('fast',function(){$treeViewRootElem.removeClass("k-custom-visible")})}}})},value:function(v){var self=this;if(v!==undefined){if(v===""){$(self._dropdown.element).closest("span.k-dropdown").find("span.k-input").text("");self._dropdown.value("")}else{self._treeView.expand(".k-item");setTimeout(function(){var n=self._treeView.dataSource.get(v);if(n){var selectNode=self._treeView.findByUid(n.uid);self._treeView.select(selectNode);self._treeView.trigger('select',{node:selectNode});var $treeViewRootElem=$(self._treeView.element);$treeViewRootElem.hide()}},200)}}else{return self._dropdown.value()}},dropDownList:function(){return this._dropdown},treeView:function(){return this._treeView},refresh:function(){return this._treeView.dataSource.read()},options:{name:"DropDownTreeView"}});kendo.ui.plugin(DropDownTreeView);var ComboBox=ui.ComboBox;var SearchBox=ComboBox.extend({init:function(element,options){var that=this;options.change=function(e){var value=this.value();var target=$.grep(that.dataSource.data(),function(v){return v[options.dataValueField]==value});if(target.length<=0){this.text('');this.value('')}};ComboBox.fn.init.call(this,element,options);$(element).siblings("span").children("input.k-input").keyup(function(event){that.search($(this).val())})},options:{name:"SearchBox"}});ui.plugin(SearchBox)})(jQuery);